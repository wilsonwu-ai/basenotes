{%- comment -%}
  Product Card Component
  Usage: {% render 'product-card', product: product, show_quick_add: true %}
{%- endcomment -%}

{%- liquid
  assign show_quick_add = show_quick_add | default: true
  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = product.featured_image
  assign secondary_image = product.images[1]
-%}

<article class="product-card" data-product-id="{{ product.id }}">
  <a href="{{ product.url }}" class="product-card__link">
    <div class="product-card__media">
      {% comment %} Badges {% endcomment %}
      <div class="product-card__badges">
        {%- if product.available == false -%}
          <span class="product-card__badge product-card__badge--sold-out">Sold Out</span>
        {%- else -%}
          {%- if product.tags contains 'new' -%}
            <span class="product-card__badge product-card__badge--new">New</span>
          {%- endif -%}
          {%- if product.tags contains 'bestseller' -%}
            <span class="product-card__badge product-card__badge--bestseller">Bestseller</span>
          {%- endif -%}
          {%- if product.tags contains 'exclusive' -%}
            <span class="product-card__badge product-card__badge--exclusive">Exclusive</span>
          {%- endif -%}
          {%- if product.tags contains 'limited' -%}
            <span class="product-card__badge product-card__badge--limited">Limited</span>
          {%- endif -%}
        {%- endif -%}
      </div>

      {% comment %} Wishlist Button {% endcomment %}
      <button class="product-card__wishlist" data-wishlist-toggle="{{ product.id }}" type="button" aria-label="Add to wishlist">
        <svg class="product-card__wishlist-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>

      {% comment %} Product Images {% endcomment %}
      <div class="product-card__image-wrapper">
        {%- if featured_image != blank -%}
          <img
            src="{{ featured_image | image_url: width: 600 }}"
            srcset="{{ featured_image | image_url: width: 300 }} 300w, {{ featured_image | image_url: width: 450 }} 450w, {{ featured_image | image_url: width: 600 }} 600w"
            sizes="(max-width: 480px) 50vw, (max-width: 768px) 33vw, 25vw"
            alt="{{ featured_image.alt | default: product.title }}"
            loading="lazy"
            class="product-card__image product-card__image--primary"
          >
          {%- if secondary_image != blank -%}
            <img
              src="{{ secondary_image | image_url: width: 600 }}"
              srcset="{{ secondary_image | image_url: width: 300 }} 300w, {{ secondary_image | image_url: width: 450 }} 450w, {{ secondary_image | image_url: width: 600 }} 600w"
              sizes="(max-width: 480px) 50vw, (max-width: 768px) 33vw, 25vw"
              alt="{{ secondary_image.alt | default: product.title }}"
              loading="lazy"
              class="product-card__image product-card__image--secondary"
            >
          {%- endif -%}
        {%- else -%}
          <div class="product-card__placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <path d="m21 15-5-5L5 21"/>
            </svg>
          </div>
        {%- endif -%}
      </div>

      {% comment %} Quick View Overlay {% endcomment %}
      {%- if product.available -%}
        <div class="product-card__overlay">
          <span class="product-card__quick-view">View Details</span>
        </div>
      {%- endif -%}
    </div>

    <div class="product-card__content">
      <span class="product-card__vendor">{{ product.vendor | default: 'Basenotes Atelier' }}</span>
      <h3 class="product-card__title">{{ product.title }}</h3>

      {% comment %} Fragrance Notes from Tags {% endcomment %}
      {%- assign note_tags = '' -%}
      {%- for tag in product.tags -%}
        {%- unless tag contains ':' or tag == 'new' or tag == 'bestseller' or tag == 'exclusive' or tag == 'limited' -%}
          {%- if note_tags != '' -%}
            {%- assign note_tags = note_tags | append: ', ' -%}
          {%- endif -%}
          {%- assign note_tags = note_tags | append: tag -%}
        {%- endunless -%}
      {%- endfor -%}
      {%- if note_tags != '' -%}
        <p class="product-card__notes">{{ note_tags | truncate: 40 }}</p>
      {%- endif -%}

      <div class="product-card__footer">
        <div class="product-card__pricing">
          <span class="product-card__price">
            {{ settings.subscription_price | default: '$20' }}
            <span class="product-card__price-period">/mo</span>
          </span>
        </div>

        {% comment %} Rating Stars (placeholder) {% endcomment %}
        {%- if product.metafields.reviews.rating != blank -%}
          <div class="product-card__rating">
            {%- assign rating = product.metafields.reviews.rating.value | round: 1 -%}
            <div class="product-card__stars" style="--rating: {{ rating }};">
              <svg viewBox="0 0 20 20"><polygon points="10 1 12.5 7.5 20 7.5 14 12 16 19 10 15 4 19 6 12 0 7.5 7.5 7.5"/></svg>
              <svg viewBox="0 0 20 20"><polygon points="10 1 12.5 7.5 20 7.5 14 12 16 19 10 15 4 19 6 12 0 7.5 7.5 7.5"/></svg>
              <svg viewBox="0 0 20 20"><polygon points="10 1 12.5 7.5 20 7.5 14 12 16 19 10 15 4 19 6 12 0 7.5 7.5 7.5"/></svg>
              <svg viewBox="0 0 20 20"><polygon points="10 1 12.5 7.5 20 7.5 14 12 16 19 10 15 4 19 6 12 0 7.5 7.5 7.5"/></svg>
              <svg viewBox="0 0 20 20"><polygon points="10 1 12.5 7.5 20 7.5 14 12 16 19 10 15 4 19 6 12 0 7.5 7.5 7.5"/></svg>
            </div>
            <span class="product-card__rating-count">({{ product.metafields.reviews.count.value | default: 0 }})</span>
          </div>
        {%- endif -%}
      </div>
    </div>
  </a>

  {% comment %} Quick Add Button {% endcomment %}
  {%- if show_quick_add and product.available -%}
    <button
      class="product-card__add-btn"
      data-quick-add="{{ current_variant.id }}"
      data-product-url="{{ product.url }}"
      type="button"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      <span>Add to Queue</span>
    </button>
  {%- elsif product.available == false -%}
    <div class="product-card__sold-out-btn">
      <span>Sold Out</span>
    </div>
  {%- endif -%}
</article>

<style>
  .product-card {
    position: relative;
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .product-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
  }

  .product-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  /* Media / Image Container */
  .product-card__media {
    position: relative;
    aspect-ratio: 3 / 4;
    background: var(--color-background-secondary);
    overflow: hidden;
  }

  .product-card__image-wrapper {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.4s ease, transform 0.6s ease;
  }

  .product-card__image--secondary {
    position: absolute;
    inset: 0;
    opacity: 0;
  }

  .product-card:hover .product-card__image--primary {
    opacity: 0;
  }

  .product-card:hover .product-card__image--secondary {
    opacity: 1;
  }

  .product-card:hover .product-card__image {
    transform: scale(1.05);
  }

  .product-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
  }

  .product-card__placeholder svg {
    width: 48px;
    height: 48px;
    opacity: 0.3;
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: var(--spacing-sm);
    left: var(--spacing-sm);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    z-index: 3;
  }

  .product-card__badge {
    display: inline-block;
    padding: 4px 10px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-sm);
  }

  .product-card__badge--new,
  .product-card__badge--bestseller {
    background: var(--color-secondary);
    color: var(--color-primary);
  }

  .product-card__badge--exclusive,
  .product-card__badge--limited {
    background: var(--color-primary);
    color: white;
  }

  .product-card__badge--sold-out {
    background: var(--color-text-muted);
    color: white;
  }

  /* Wishlist */
  .product-card__wishlist {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 3;
    opacity: 0;
    transform: translateY(-4px);
    transition: opacity 0.2s, transform 0.2s, background 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .product-card:hover .product-card__wishlist {
    opacity: 1;
    transform: translateY(0);
  }

  .product-card__wishlist:hover {
    background: var(--color-secondary);
  }

  .product-card__wishlist-icon {
    width: 18px;
    height: 18px;
    color: var(--color-text);
    transition: color 0.2s;
  }

  .product-card__wishlist:hover .product-card__wishlist-icon {
    color: var(--color-primary);
  }

  .product-card__wishlist.is-active .product-card__wishlist-icon {
    fill: var(--color-error);
    stroke: var(--color-error);
  }

  /* Quick View Overlay */
  .product-card__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 2;
  }

  .product-card:hover .product-card__overlay {
    opacity: 1;
  }

  .product-card__quick-view {
    padding: var(--spacing-sm) var(--spacing-lg);
    background: white;
    color: var(--color-primary);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border-radius: var(--radius-sm);
    transform: translateY(10px);
    transition: transform 0.3s ease;
  }

  .product-card:hover .product-card__quick-view {
    transform: translateY(0);
  }

  /* Content */
  .product-card__content {
    padding: var(--spacing-md);
    text-align: center;
  }

  .product-card__vendor {
    display: block;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-xs);
  }

  .product-card__title {
    font-size: var(--font-size-base);
    font-weight: 600;
    margin: 0 0 var(--spacing-xs);
    line-height: 1.3;
    color: var(--color-text);
  }

  .product-card__notes {
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
    margin: 0 0 var(--spacing-sm);
    line-height: 1.4;
  }

  .product-card__footer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .product-card__pricing {
    display: flex;
    align-items: baseline;
    justify-content: center;
  }

  .product-card__price {
    font-size: var(--font-size-lg);
    font-weight: 700;
    color: var(--color-primary);
  }

  .product-card__price-period {
    font-size: var(--font-size-sm);
    font-weight: 400;
    color: var(--color-text-light);
  }

  /* Rating */
  .product-card__rating {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .product-card__stars {
    display: flex;
    gap: 2px;
  }

  .product-card__stars svg {
    width: 12px;
    height: 12px;
    fill: var(--color-secondary);
    stroke: var(--color-secondary);
    stroke-width: 0.5;
  }

  .product-card__rating-count {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
  }

  /* Add Button */
  .product-card__add-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    width: 100%;
    padding: var(--spacing-md);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: white;
    background: var(--color-primary);
    border: none;
    cursor: pointer;
    transition: background 0.2s;
  }

  .product-card__add-btn:hover {
    background: #2a2a2a;
  }

  .product-card__add-btn svg {
    width: 16px;
    height: 16px;
  }

  .product-card__add-btn.is-loading {
    pointer-events: none;
  }

  .product-card__add-btn.is-loading svg {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .product-card__add-btn.is-added {
    background: var(--color-success);
  }

  .product-card__sold-out-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: var(--spacing-md);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    background: var(--color-background-secondary);
    border-top: 1px solid var(--color-border);
  }

  /* List View Styles */
  .is-list-view .product-card {
    display: grid;
    grid-template-columns: 200px 1fr auto;
    align-items: center;
  }

  .is-list-view .product-card__media {
    aspect-ratio: 1;
  }

  .is-list-view .product-card__content {
    text-align: left;
    padding: var(--spacing-lg);
  }

  .is-list-view .product-card__footer {
    align-items: flex-start;
  }

  .is-list-view .product-card__add-btn,
  .is-list-view .product-card__sold-out-btn {
    width: auto;
    padding: var(--spacing-md) var(--spacing-xl);
    margin: var(--spacing-lg);
    border-radius: var(--radius-sm);
  }

  @media (max-width: 768px) {
    .is-list-view .product-card {
      grid-template-columns: 120px 1fr;
    }

    .is-list-view .product-card__add-btn,
    .is-list-view .product-card__sold-out-btn {
      grid-column: span 2;
      width: 100%;
      margin: 0;
      border-radius: 0;
    }
  }
</style>

<script>
  (function() {
    // Quick Add functionality
    document.addEventListener('click', function(e) {
      const addBtn = e.target.closest('[data-quick-add]');
      if (!addBtn) return;

      e.preventDefault();
      const variantId = addBtn.dataset.quickAdd;

      // Set loading state
      addBtn.classList.add('is-loading');
      const originalText = addBtn.querySelector('span')?.textContent;
      if (addBtn.querySelector('span')) {
        addBtn.querySelector('span').textContent = 'Adding...';
      }

      fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: variantId,
          quantity: 1
        })
      })
      .then(response => response.json())
      .then(data => {
        addBtn.classList.remove('is-loading');
        addBtn.classList.add('is-added');
        if (addBtn.querySelector('span')) {
          addBtn.querySelector('span').textContent = 'Added!';
        }

        // Update cart count in header
        fetch('/cart.js')
          .then(res => res.json())
          .then(cart => {
            const cartCount = document.querySelector('[data-cart-count]');
            if (cartCount) {
              cartCount.textContent = cart.item_count;
              cartCount.classList.remove('is-hidden');
            }

            // Open cart drawer if it exists
            const cartDrawer = document.querySelector('[data-cart-drawer]');
            if (cartDrawer) {
              cartDrawer.classList.add('is-open');
              document.body.style.overflow = 'hidden';
            }
          });

        // Reset button after delay
        setTimeout(() => {
          addBtn.classList.remove('is-added');
          if (addBtn.querySelector('span')) {
            addBtn.querySelector('span').textContent = originalText;
          }
        }, 2000);
      })
      .catch(error => {
        console.error('Error adding to cart:', error);
        addBtn.classList.remove('is-loading');
        if (addBtn.querySelector('span')) {
          addBtn.querySelector('span').textContent = 'Error';
        }
        setTimeout(() => {
          if (addBtn.querySelector('span')) {
            addBtn.querySelector('span').textContent = originalText;
          }
        }, 2000);
      });
    });

    // Wishlist toggle (basic implementation - would need backend support)
    document.addEventListener('click', function(e) {
      const wishlistBtn = e.target.closest('[data-wishlist-toggle]');
      if (!wishlistBtn) return;

      e.preventDefault();
      e.stopPropagation();
      wishlistBtn.classList.toggle('is-active');

      const productId = wishlistBtn.dataset.wishlistToggle;
      let wishlist = JSON.parse(localStorage.getItem('basenotes_wishlist') || '[]');

      if (wishlistBtn.classList.contains('is-active')) {
        if (!wishlist.includes(productId)) {
          wishlist.push(productId);
        }
      } else {
        wishlist = wishlist.filter(id => id !== productId);
      }

      localStorage.setItem('basenotes_wishlist', JSON.stringify(wishlist));
    });

    // Initialize wishlist state
    const wishlist = JSON.parse(localStorage.getItem('basenotes_wishlist') || '[]');
    document.querySelectorAll('[data-wishlist-toggle]').forEach(btn => {
      if (wishlist.includes(btn.dataset.wishlistToggle)) {
        btn.classList.add('is-active');
      }
    });
  })();
</script>
