{%- layout 'theme' -%}

<section class="section" style="padding-top: calc(var(--header-height) + var(--spacing-2xl));">
  <div class="container">
    <div class="account-layout">

      {% comment %} Sidebar Navigation {% endcomment %}
      <aside class="account-sidebar">
        <div style="margin-bottom: var(--spacing-xl);">
          <p style="font-size: var(--font-size-sm); color: var(--color-text-light);">Welcome back,</p>
          <p style="font-size: var(--font-size-xl); font-family: var(--font-heading);">{{ customer.first_name }}</p>
        </div>

        <ul class="account-nav">
          <li class="account-nav__item">
            <a href="{{ routes.account_url }}" class="account-nav__link">Dashboard</a>
          </li>
          <li class="account-nav__item">
            <a href="{{ routes.account_url }}#orders" class="account-nav__link">Order History</a>
          </li>
          <li class="account-nav__item">
            <a href="{{ routes.account_addresses_url }}" class="account-nav__link is-active">Addresses</a>
          </li>
          <li class="account-nav__item">
            <a href="#subscription" class="account-nav__link">My Subscription</a>
          </li>
          <li class="account-nav__item">
            <a href="#queue" class="account-nav__link">Fragrance Queue</a>
          </li>
        </ul>

        <div style="margin-top: var(--spacing-xl); padding-top: var(--spacing-xl); border-top: 1px solid var(--color-border);">
          <a href="{{ routes.account_logout_url }}" style="font-size: var(--font-size-sm); color: var(--color-text-light);">
            Sign Out
          </a>
        </div>
      </aside>

      {% comment %} Main Content {% endcomment %}
      <main class="account-content">
        <div class="account-header">
          <h1 class="account-header__title">Addresses</h1>
          <p class="account-header__subtitle">Manage your shipping addresses.</p>
        </div>

        {% comment %} Add New Address Button {% endcomment %}
        <button type="button" class="btn btn--primary" id="addAddressBtn" style="margin-bottom: var(--spacing-2xl);">
          Add New Address
        </button>

        {% comment %} New Address Form (Hidden by default) {% endcomment %}
        <div id="newAddressForm" style="display: none; margin-bottom: var(--spacing-2xl); padding: var(--spacing-xl); border: 1px solid var(--color-border);">
          <h3 style="margin-bottom: var(--spacing-lg);">Add New Address</h3>

          {%- form 'customer_address', customer.new_address -%}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div class="form-group">
                <label class="form-label" for="AddressFirstName">First Name</label>
                <input type="text" name="address[first_name]" id="AddressFirstName" class="form-input" autocomplete="given-name">
              </div>
              <div class="form-group">
                <label class="form-label" for="AddressLastName">Last Name</label>
                <input type="text" name="address[last_name]" id="AddressLastName" class="form-input" autocomplete="family-name">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="AddressCompany">Company (Optional)</label>
              <input type="text" name="address[company]" id="AddressCompany" class="form-input" autocomplete="organization">
            </div>

            <div class="form-group">
              <label class="form-label" for="AddressAddress1">Address</label>
              <input type="text" name="address[address1]" id="AddressAddress1" class="form-input" autocomplete="address-line1" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="AddressAddress2">Apartment, suite, etc. (Optional)</label>
              <input type="text" name="address[address2]" id="AddressAddress2" class="form-input" autocomplete="address-line2">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md);">
              <div class="form-group">
                <label class="form-label" for="AddressCity">City</label>
                <input type="text" name="address[city]" id="AddressCity" class="form-input" autocomplete="address-level2" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="AddressCountry">Country</label>
                <select name="address[country]" id="AddressCountry" class="form-select" data-default="{{ customer.default_address.country | default: 'United States' }}">
                  {{ all_country_option_tags }}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="AddressProvince">State/Province</label>
                <select name="address[province]" id="AddressProvince" class="form-select" data-default="{{ customer.default_address.province }}"></select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
              <div class="form-group">
                <label class="form-label" for="AddressZip">Postal/Zip Code</label>
                <input type="text" name="address[zip]" id="AddressZip" class="form-input" autocomplete="postal-code" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="AddressPhone">Phone (Optional)</label>
                <input type="tel" name="address[phone]" id="AddressPhone" class="form-input" autocomplete="tel">
              </div>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <input type="checkbox" name="address[default]" value="1">
                Set as default address
              </label>
            </div>

            <div style="display: flex; gap: var(--spacing-md);">
              <button type="submit" class="btn btn--primary">Save Address</button>
              <button type="button" class="btn btn--outline" id="cancelAddressBtn">Cancel</button>
            </div>
          {%- endform -%}
        </div>

        {% comment %} Existing Addresses {% endcomment %}
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-lg);">
          {%- for address in customer.addresses -%}
            <div style="padding: var(--spacing-xl); border: 1px solid var(--color-border); {% if address == customer.default_address %}border-color: var(--color-secondary);{% endif %}">
              {%- if address == customer.default_address -%}
                <span class="badge badge--gold" style="margin-bottom: var(--spacing-md);">Default</span>
              {%- endif -%}

              <p style="font-weight: 500;">{{ address.first_name }} {{ address.last_name }}</p>
              <p style="color: var(--color-text-light); margin: var(--spacing-sm) 0;">
                {%- if address.company != blank -%}{{ address.company }}<br>{%- endif -%}
                {{ address.address1 }}<br>
                {%- if address.address2 != blank -%}{{ address.address2 }}<br>{%- endif -%}
                {{ address.city }}, {{ address.province_code }} {{ address.zip }}<br>
                {{ address.country }}
                {%- if address.phone != blank -%}<br>{{ address.phone }}{%- endif -%}
              </p>

              <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <a href="{{ address.url }}" style="font-size: var(--font-size-sm); color: var(--color-secondary);">Edit</a>
                <button
                  type="button"
                  data-delete-address="{{ address.url }}"
                  style="font-size: var(--font-size-sm); color: var(--color-error); background: none; border: none; cursor: pointer;"
                >
                  Delete
                </button>
              </div>
            </div>
          {%- else -%}
            <div style="grid-column: span 2; text-align: center; padding: var(--spacing-3xl); background: var(--color-background-secondary);">
              <p style="color: var(--color-text-light);">No addresses saved yet.</p>
            </div>
          {%- endfor -%}
        </div>
      </main>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addAddressBtn');
    const cancelBtn = document.getElementById('cancelAddressBtn');
    const form = document.getElementById('newAddressForm');

    addBtn?.addEventListener('click', () => {
      form.style.display = 'block';
      addBtn.style.display = 'none';
    });

    cancelBtn?.addEventListener('click', () => {
      form.style.display = 'none';
      addBtn.style.display = 'inline-flex';
    });

    // Delete address confirmation
    document.querySelectorAll('[data-delete-address]').forEach(btn => {
      btn.addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this address?')) {
          Shopify.postLink(this.dataset.deleteAddress, { parameters: { _method: 'delete' } });
        }
      });
    });
  });
</script>
